{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "286df97c",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-09-14T19:13:43.252056Z",
     "iopub.status.busy": "2024-09-14T19:13:43.251695Z",
     "iopub.status.idle": "2024-09-14T19:13:45.479566Z",
     "shell.execute_reply": "2024-09-14T19:13:45.478771Z"
    },
    "papermill": {
     "duration": 2.235483,
     "end_time": "2024-09-14T19:13:45.481895",
     "exception": false,
     "start_time": "2024-09-14T19:13:43.246412",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Ariel Data Challenge 2024: Exoplanet Spectrum Analysis Pipeline\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "import matplotlib.pyplot as plt\n",
    "from scipy import signal\n",
    "from scipy.ndimage import gaussian_filter1d\n",
    "from scipy.optimize import minimize\n",
    "from scipy.signal import savgol_filter\n",
    "from scipy.interpolate import interp1d\n",
    "from sklearn.decomposition import PCA\n",
    "from sklearn.model_selection import train_test_split\n",
    "from sklearn.linear_model import LinearRegression\n",
    "from sklearn.ensemble import RandomForestRegressor\n",
    "from sklearn.metrics import mean_squared_error, r2_score\n",
    "import gc\n",
    "import logging\n",
    "from tqdm.notebook import tqdm"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "26b309c0",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-09-14T19:13:45.490037Z",
     "iopub.status.busy": "2024-09-14T19:13:45.489620Z",
     "iopub.status.idle": "2024-09-14T19:13:45.495435Z",
     "shell.execute_reply": "2024-09-14T19:13:45.494626Z"
    },
    "papermill": {
     "duration": 0.011793,
     "end_time": "2024-09-14T19:13:45.497343",
     "exception": false,
     "start_time": "2024-09-14T19:13:45.485550",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# 1. Data Loading Functions\n",
    "\n",
    "def load_planet_data(planet_id, data_path):\n",
    "    airs_signal = pd.read_parquet(f\"{data_path}/train/{planet_id}/AIRS-CH0_signal.parquet\")\n",
    "    fgs1_signal = pd.read_parquet(f\"{data_path}/train/{planet_id}/FGS1_signal.parquet\")\n",
    "    \n",
    "    calibration_files = {\n",
    "        'dark': pd.read_parquet(f\"{data_path}/train/{planet_id}/AIRS-CH0_calibration/dark.parquet\"),\n",
    "        'flat': pd.read_parquet(f\"{data_path}/train/{planet_id}/AIRS-CH0_calibration/flat.parquet\"),\n",
    "        'dead': pd.read_parquet(f\"{data_path}/train/{planet_id}/AIRS-CH0_calibration/dead.parquet\"),\n",
    "        'linear_corr': pd.read_parquet(f\"{data_path}/train/{planet_id}/AIRS-CH0_calibration/linear_corr.parquet\")\n",
    "    }\n",
    "    \n",
    "    return airs_signal, fgs1_signal, calibration_files"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "cea84563",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-09-14T19:13:45.504958Z",
     "iopub.status.busy": "2024-09-14T19:13:45.504678Z",
     "iopub.status.idle": "2024-09-14T19:13:45.516701Z",
     "shell.execute_reply": "2024-09-14T19:13:45.515938Z"
    },
    "papermill": {
     "duration": 0.017985,
     "end_time": "2024-09-14T19:13:45.518477",
     "exception": false,
     "start_time": "2024-09-14T19:13:45.500492",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# 2. Data Preprocessing Functions\n",
    "\n",
    "def reshape_and_calibrate(airs_signal, calibration_files):\n",
    "    airs_data = airs_signal.values.reshape(-1, 32, 356)\n",
    "    airs_data = (airs_data - calibration_files['dark'].values) / calibration_files['flat'].values\n",
    "    return airs_data\n",
    "\n",
    "def extract_spectral_data(airs_data):\n",
    "    return np.mean(airs_data, axis=1)\n",
    "\n",
    "def measure_centroid(image):\n",
    "    y, x = np.indices(image.shape)\n",
    "    total = image.sum()\n",
    "    x_center = (x * image).sum() / total\n",
    "    y_center = (y * image).sum() / total\n",
    "    return x_center, y_center\n",
    "\n",
    "def correct_jitter(airs_data, fgs1_data, airs_time, fgs1_time):\n",
    "    # Ensure FGS1 data covers the full AIRS-CH0 time range\n",
    "    fgs1_start = max(fgs1_time.min(), airs_time.min())\n",
    "    fgs1_end = min(fgs1_time.max(), airs_time.max())\n",
    "    mask = (fgs1_time >= fgs1_start) & (fgs1_time <= fgs1_end)\n",
    "    fgs1_time = fgs1_time[mask]\n",
    "    fgs1_data = fgs1_data[mask]\n",
    "\n",
    "    # Interpolate FGS1 centroid positions to AIRS-CH0 timestamps\n",
    "    interp_x = interp1d(fgs1_time, fgs1_data[:, 0], kind='cubic', fill_value='extrapolate')\n",
    "    interp_y = interp1d(fgs1_time, fgs1_data[:, 1], kind='cubic', fill_value='extrapolate')\n",
    "    \n",
    "    x_pos = interp_x(airs_time)\n",
    "    y_pos = interp_y(airs_time)\n",
    "\n",
    "    # Smooth the centroid positions to reduce noise\n",
    "    x_smooth = savgol_filter(x_pos, window_length=51, polyorder=3)\n",
    "    y_smooth = savgol_filter(y_pos, window_length=51, polyorder=3)\n",
    "\n",
    "    # Calculate pixel shifts\n",
    "    x_shift = x_smooth - np.median(x_smooth)\n",
    "    y_shift = y_smooth - np.median(y_smooth)\n",
    "\n",
    "    # Correct AIRS-CH0 data for jitter\n",
    "    corrected_data = np.zeros_like(airs_data)\n",
    "    for i in range(airs_data.shape[1]):\n",
    "        # Create a 2D interpolation function for each wavelength\n",
    "        interp_func = interp1d(airs_time, airs_data[:, i], kind='cubic', fill_value='extrapolate')\n",
    "        \n",
    "        # Apply correction\n",
    "        corrected_time = airs_time - x_shift * 0.1 - y_shift * 0.1  # Adjust scaling factors as needed\n",
    "        corrected_data[:, i] = interp_func(corrected_time)\n",
    "\n",
    "    return corrected_data\n",
    "\n",
    "def normalize_data(data):\n",
    "    mean = np.mean(data, axis=0)\n",
    "    std = np.std(data, axis=0)\n",
    "    return (data - mean) / (std + 1e-10)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "6671c321",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-09-14T19:13:45.526144Z",
     "iopub.status.busy": "2024-09-14T19:13:45.525671Z",
     "iopub.status.idle": "2024-09-14T19:13:45.538142Z",
     "shell.execute_reply": "2024-09-14T19:13:45.537357Z"
    },
    "papermill": {
     "duration": 0.018218,
     "end_time": "2024-09-14T19:13:45.539887",
     "exception": false,
     "start_time": "2024-09-14T19:13:45.521669",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# 3. Model Building Functions\n",
    "\n",
    "def simple_transit_model(params, time):\n",
    "    t0, per, depth, duration = params\n",
    "    phase = (time - t0 + 0.5*per) % per - 0.5*per\n",
    "    transit = np.abs(phase) < 0.5*duration\n",
    "    return 1 - depth * transit\n",
    "\n",
    "def fit_transit_model(flux, time):\n",
    "    def residuals(params):\n",
    "        return np.sum((flux - simple_transit_model(params, time))**2)\n",
    "    \n",
    "    initial_guess = [np.median(time), 0.1 * (time[-1] - time[0]), 0.01, 0.1 * (time[-1] - time[0])]\n",
    "    bounds = ((0, len(time)), (0, len(time)), (0, 0.1), (0, len(time)/2))\n",
    "    result = minimize(residuals, initial_guess, bounds=bounds, method='L-BFGS-B')\n",
    "    return result.x\n",
    "\n",
    "def process_planet(planet_id, data_path, axis_info):\n",
    "    # Load data\n",
    "    airs_signal, fgs1_signal, calibration_files = load_planet_data(planet_id, data_path)\n",
    "    \n",
    "    # Preprocess data\n",
    "    airs_data = reshape_and_calibrate(airs_signal, calibration_files)\n",
    "    spectral_data = extract_spectral_data(airs_data)\n",
    "    \n",
    "    # Time arrays\n",
    "    airs_time_step = axis_info['AIRS-CH0-axis0-h'].iloc[1] - axis_info['AIRS-CH0-axis0-h'].iloc[0]\n",
    "    time = np.arange(len(spectral_data)) * airs_time_step\n",
    "    \n",
    "    fgs1_data = fgs1_signal.values.reshape(-1, 32, 32)\n",
    "    fgs1_centroids = np.array([measure_centroid(frame) for frame in fgs1_data])\n",
    "    fgs1_time_step = axis_info['FGS1-axis0-h'].iloc[1] - axis_info['FGS1-axis0-h'].iloc[0]\n",
    "    fgs1_time = np.arange(len(fgs1_data)) * fgs1_time_step\n",
    "    \n",
    "    # Jitter correction\n",
    "    corrected_spectral_data = correct_jitter(spectral_data, fgs1_centroids, time, fgs1_time)\n",
    "    \n",
    "    # Fit transit model for each wavelength\n",
    "    transit_params = np.array([fit_transit_model(corrected_spectral_data[:, i], time) \n",
    "                               for i in range(corrected_spectral_data.shape[1])])\n",
    "    \n",
    "    # Extract spectrum and estimate uncertainties\n",
    "    spectrum = np.mean(corrected_spectral_data, axis=0)\n",
    "    uncertainties = np.std(corrected_spectral_data, axis=0) / np.sqrt(len(corrected_spectral_data))\n",
    "    \n",
    "    return {\n",
    "        'wavelengths': pd.read_csv(f\"{data_path}/wavelengths.csv\").iloc[0].values,\n",
    "        'spectrum': spectrum,\n",
    "        'uncertainties': uncertainties,\n",
    "        'transit_params': transit_params\n",
    "    }"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "8175fa7a",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-09-14T19:13:45.547359Z",
     "iopub.status.busy": "2024-09-14T19:13:45.547081Z",
     "iopub.status.idle": "2024-09-14T19:13:45.552599Z",
     "shell.execute_reply": "2024-09-14T19:13:45.551793Z"
    },
    "papermill": {
     "duration": 0.011518,
     "end_time": "2024-09-14T19:13:45.554659",
     "exception": false,
     "start_time": "2024-09-14T19:13:45.543141",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# 4. Main Processing Loop\n",
    "def process_all_planets(data_path, train_adc_info, axis_info):\n",
    "    all_results = {}\n",
    "    total_planets = len(train_adc_info.index)\n",
    "    \n",
    "    for i, planet_id in enumerate(tqdm(train_adc_info.index, desc=\"Processing planets\")):\n",
    "        results = process_planet(str(planet_id), data_path, axis_info)\n",
    "        if results is not None:\n",
    "            all_results[planet_id] = results\n",
    "        \n",
    "        # Optional: Print progress every 10%\n",
    "        if (i + 1) % (total_planets // 10) == 0:\n",
    "            print(f\"Processed {i + 1}/{total_planets} planets\")\n",
    "    \n",
    "    return all_results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "30028ce9",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-09-14T19:13:45.563464Z",
     "iopub.status.busy": "2024-09-14T19:13:45.563160Z",
     "iopub.status.idle": "2024-09-14T19:13:45.572157Z",
     "shell.execute_reply": "2024-09-14T19:13:45.571293Z"
    },
    "papermill": {
     "duration": 0.015127,
     "end_time": "2024-09-14T19:13:45.574125",
     "exception": false,
     "start_time": "2024-09-14T19:13:45.558998",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# 5. Model Evaluation and Analysis\n",
    "\n",
    "def load_processed_results(results_path, planet_ids):\n",
    "    all_results = {}\n",
    "    for planet_id in planet_ids:\n",
    "        all_results[planet_id] = np.load(f\"{results_path}/planet_{planet_id}_results.npz\", allow_pickle=True)\n",
    "    return all_results\n",
    "\n",
    "def prepare_data_for_modeling(all_results):\n",
    "    X = np.array([results['spectrum'] for results in all_results.values()])\n",
    "    y = np.array([results['transit_params'][:, 2] for results in all_results.values()])  # Using transit depth as target\n",
    "    return X, y\n",
    "\n",
    "def train_and_evaluate_models(X, y):\n",
    "    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)\n",
    "    \n",
    "    # PCA\n",
    "    pca = PCA(n_components=0.95)\n",
    "    X_train_pca = pca.fit_transform(X_train)\n",
    "    X_test_pca = pca.transform(X_test)\n",
    "    \n",
    "    # Linear Regression\n",
    "    lr = LinearRegression()\n",
    "    lr.fit(X_train_pca, y_train)\n",
    "    lr_score = lr.score(X_test_pca, y_test)\n",
    "    \n",
    "    # Random Forest\n",
    "    rf = RandomForestRegressor(n_estimators=100, random_state=42)\n",
    "    rf.fit(X_train_pca, y_train)\n",
    "    rf_score = rf.score(X_test_pca, y_test)\n",
    "    \n",
    "    print(f\"Linear Regression R2 Score: {lr_score:.4f}\")\n",
    "    print(f\"Random Forest R2 Score: {rf_score:.4f}\")\n",
    "    \n",
    "    return lr, rf, pca, X_test_pca, y_test"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "0ee679b1",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-09-14T19:13:45.582591Z",
     "iopub.status.busy": "2024-09-14T19:13:45.581999Z",
     "iopub.status.idle": "2024-09-14T19:13:45.587451Z",
     "shell.execute_reply": "2024-09-14T19:13:45.586613Z"
    },
    "papermill": {
     "duration": 0.011823,
     "end_time": "2024-09-14T19:13:45.589474",
     "exception": false,
     "start_time": "2024-09-14T19:13:45.577651",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# 5.2. Final Model Selection\n",
    "\n",
    "def select_best_model(lr_model, rf_model, X_test_pca, y_test):\n",
    "    lr_mse = mean_squared_error(y_test, lr_model.predict(X_test_pca))\n",
    "    rf_mse = mean_squared_error(y_test, rf_model.predict(X_test_pca))\n",
    "    \n",
    "    print(f\"Linear Regression MSE: {lr_mse:.6f}\")\n",
    "    print(f\"Random Forest MSE: {rf_mse:.6f}\")\n",
    "    \n",
    "    if lr_mse < rf_mse:\n",
    "        print(\"Linear Regression model selected.\")\n",
    "        return lr_model\n",
    "    else:\n",
    "        print(\"Random Forest model selected.\")\n",
    "        return rf_model"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "a3b3c88a",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-09-14T19:13:45.597614Z",
     "iopub.status.busy": "2024-09-14T19:13:45.597324Z",
     "iopub.status.idle": "2024-09-14T19:13:45.604321Z",
     "shell.execute_reply": "2024-09-14T19:13:45.603490Z"
    },
    "papermill": {
     "duration": 0.013262,
     "end_time": "2024-09-14T19:13:45.606260",
     "exception": false,
     "start_time": "2024-09-14T19:13:45.592998",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# 5.4. Uncertainty Estimation\n",
    "\n",
    "def estimate_uncertainty(model, X_pca, n_bootstrap=100):\n",
    "    predictions = []\n",
    "    for _ in range(n_bootstrap):\n",
    "        if isinstance(model, RandomForestRegressor):\n",
    "            # Randomly select estimators and average their predictions\n",
    "            n_estimators = len(model.estimators_)\n",
    "            selected_estimators = np.random.choice(model.estimators_, size=n_estimators, replace=True)\n",
    "            preds = np.mean([estimator.predict(X_pca) for estimator in selected_estimators], axis=0)\n",
    "        elif isinstance(model, LinearRegression):\n",
    "            # Add noise to the coefficients\n",
    "            coef_noise = np.random.normal(0, 0.1, size=model.coef_.shape)\n",
    "            preds = X_pca @ (model.coef_ + coef_noise).T + model.intercept_\n",
    "        else:\n",
    "            raise ValueError(\"Unsupported model type\")\n",
    "        predictions.append(preds)\n",
    "    \n",
    "    return np.std(predictions, axis=0)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "e14502a2",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-09-14T19:13:45.614581Z",
     "iopub.status.busy": "2024-09-14T19:13:45.614314Z",
     "iopub.status.idle": "2024-09-14T19:13:45.624738Z",
     "shell.execute_reply": "2024-09-14T19:13:45.623888Z"
    },
    "papermill": {
     "duration": 0.016751,
     "end_time": "2024-09-14T19:13:45.626588",
     "exception": false,
     "start_time": "2024-09-14T19:13:45.609837",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# 5.6. Submission Preparation\n",
    "def prepare_submission(model, pca_model, all_results, output_file):\n",
    "    planet_ids = list(all_results.keys())\n",
    "    all_data = []\n",
    "    \n",
    "    for planet_id in planet_ids:\n",
    "        spectrum = all_results[planet_id]['spectrum']\n",
    "        spectrum_pca = pca_model.transform(spectrum.reshape(1, -1))\n",
    "        predicted_spectrum = model.predict(spectrum_pca).flatten()\n",
    "        spectrum_uncertainty = estimate_uncertainty(model, spectrum_pca)\n",
    "        \n",
    "        # Ensure we have exactly 283 values for both spectrum and uncertainty\n",
    "        predicted_spectrum = predicted_spectrum[:283]  # Truncate or pad to 283\n",
    "        spectrum_uncertainty = spectrum_uncertainty[:283]  # Truncate or pad to 283\n",
    "        \n",
    "        # Pad with zeros if less than 283\n",
    "        if len(predicted_spectrum) < 283:\n",
    "            predicted_spectrum = np.pad(predicted_spectrum, (0, 283 - len(predicted_spectrum)))\n",
    "        if len(spectrum_uncertainty) < 283:\n",
    "            spectrum_uncertainty = np.pad(spectrum_uncertainty, (0, 283 - len(spectrum_uncertainty)))\n",
    "        \n",
    "        # Combine all data for this planet\n",
    "        planet_data = [planet_id] + list(predicted_spectrum) + list(spectrum_uncertainty)\n",
    "        all_data.append(planet_data)\n",
    "    \n",
    "    # Create column names\n",
    "    column_names = ['planet_id'] + [f'spectrum_{i}' for i in range(283)] + [f'uncertainty_{i}' for i in range(283)]\n",
    "    \n",
    "    # Create DataFrame\n",
    "    submission_df = pd.DataFrame(all_data, columns=column_names)\n",
    "    \n",
    "    # Save to CSV\n",
    "    submission_df.to_csv(output_file, index=False)\n",
    "    print(f\"Submission file saved to {output_file}\")\n",
    "\n",
    "    # Verify the shape\n",
    "    print(f\"Submission file shape: {submission_df.shape}\")\n",
    "    print(f\"Number of columns: {len(submission_df.columns)}\")\n",
    "    print(\"First few columns:\", submission_df.columns[:5].tolist())\n",
    "    print(\"Last few columns:\", submission_df.columns[-5:].tolist())\n",
    "\n",
    "    # Additional verification\n",
    "    print(f\"Number of spectrum columns: {sum('spectrum_' in col for col in submission_df.columns)}\")\n",
    "    print(f\"Number of uncertainty columns: {sum('uncertainty_' in col for col in submission_df.columns)}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "90753cdd",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-09-14T19:13:45.635420Z",
     "iopub.status.busy": "2024-09-14T19:13:45.635134Z",
     "iopub.status.idle": "2024-09-14T22:05:34.741208Z",
     "shell.execute_reply": "2024-09-14T22:05:34.740188Z"
    },
    "papermill": {
     "duration": 10309.117681,
     "end_time": "2024-09-14T22:05:34.748196",
     "exception": false,
     "start_time": "2024-09-14T19:13:45.630515",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Starting planet processing\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "4ec719ebf36048138c22ac14b7617eb3",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Processing planets:   0%|          | 0/673 [00:00<?, ?it/s]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Processed 67/673 planets\n",
      "Processed 134/673 planets\n",
      "Processed 201/673 planets\n",
      "Processed 268/673 planets\n",
      "Processed 335/673 planets\n",
      "Processed 402/673 planets\n",
      "Processed 469/673 planets\n",
      "Processed 536/673 planets\n",
      "Processed 603/673 planets\n",
      "Processed 670/673 planets\n",
      "Preparing data for modeling\n",
      "Shape of X: (673, 356)\n",
      "Shape of y: (673, 356)\n",
      "Training and evaluating models\n",
      "Linear Regression R2 Score: -0.0013\n",
      "Random Forest R2 Score: 0.5081\n",
      "Number of PCA components: 2\n",
      "Shape of X_test_pca: (135, 2)\n",
      "Selecting best model\n",
      "Linear Regression MSE: 0.001128\n",
      "Random Forest MSE: 0.000528\n",
      "Random Forest model selected.\n",
      "Preparing submission\n",
      "Submission file saved to submission.csv\n",
      "Submission file shape: (673, 567)\n",
      "Number of columns: 567\n",
      "First few columns: ['planet_id', 'spectrum_0', 'spectrum_1', 'spectrum_2', 'spectrum_3']\n",
      "Last few columns: ['uncertainty_278', 'uncertainty_279', 'uncertainty_280', 'uncertainty_281', 'uncertainty_282']\n",
      "Number of spectrum columns: 283\n",
      "Number of uncertainty columns: 283\n",
      "Analysis completed successfully\n"
     ]
    }
   ],
   "source": [
    "if __name__ == \"__main__\":\n",
    "    try:\n",
    "        data_path = \"/kaggle/input/ariel-data-challenge-2024\"\n",
    "        train_adc_info = pd.read_csv(f\"{data_path}/train_adc_info.csv\", index_col='planet_id')\n",
    "        axis_info = pd.read_parquet(f\"{data_path}/axis_info.parquet\")\n",
    "        \n",
    "        print(\"Starting planet processing\")\n",
    "        all_results = process_all_planets(data_path, train_adc_info, axis_info)\n",
    "        \n",
    "        print(\"Preparing data for modeling\")\n",
    "        X, y = prepare_data_for_modeling(all_results)\n",
    "        print(f\"Shape of X: {X.shape}\")\n",
    "        print(f\"Shape of y: {y.shape}\")\n",
    "\n",
    "        print(\"Training and evaluating models\")\n",
    "        lr_model, rf_model, pca_model, X_test_pca, y_test = train_and_evaluate_models(X, y)\n",
    "        print(f\"Number of PCA components: {pca_model.n_components_}\")\n",
    "        print(f\"Shape of X_test_pca: {X_test_pca.shape}\")\n",
    "\n",
    "        print(\"Selecting best model\")\n",
    "        best_model = select_best_model(lr_model, rf_model, X_test_pca, y_test)\n",
    "        \n",
    "        print(\"Preparing submission\")\n",
    "        prepare_submission(best_model, pca_model, all_results, \"submission.csv\")\n",
    "\n",
    "        print(\"Analysis completed successfully\")\n",
    "    except Exception as e:\n",
    "        print(f\"An error occurred: {str(e)}\")\n",
    "        raise"
   ]
  }
 ],
 "metadata": {
  "kaggle": {
   "accelerator": "gpu",
   "dataSources": [
    {
     "databundleVersionId": 9188054,
     "sourceId": 70367,
     "sourceType": "competition"
    }
   ],
   "dockerImageVersionId": 30761,
   "isGpuEnabled": true,
   "isInternetEnabled": false,
   "language": "python",
   "sourceType": "notebook"
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.14"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 10314.981897,
   "end_time": "2024-09-14T22:05:35.479527",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2024-09-14T19:13:40.497630",
   "version": "2.6.0"
  },
  "widgets": {
   "application/vnd.jupyter.widget-state+json": {
    "state": {
     "0cc41ee128114e4ca3abbece6f58dc1a": {
      "model_module": "@jupyter-widgets/base",
      "model_module_version": "1.2.0",
      "model_name": "LayoutModel",
      "state": {
       "_model_module": "@jupyter-widgets/base",
       "_model_module_version": "1.2.0",
       "_model_name": "LayoutModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/base",
       "_view_module_version": "1.2.0",
       "_view_name": "LayoutView",
       "align_content": null,
       "align_items": null,
       "align_self": null,
       "border": null,
       "bottom": null,
       "display": null,
       "flex": null,
       "flex_flow": null,
       "grid_area": null,
       "grid_auto_columns": null,
       "grid_auto_flow": null,
       "grid_auto_rows": null,
       "grid_column": null,
       "grid_gap": null,
       "grid_row": null,
       "grid_template_areas": null,
       "grid_template_columns": null,
       "grid_template_rows": null,
       "height": null,
       "justify_content": null,
       "justify_items": null,
       "left": null,
       "margin": null,
       "max_height": null,
       "max_width": null,
       "min_height": null,
       "min_width": null,
       "object_fit": null,
       "object_position": null,
       "order": null,
       "overflow": null,
       "overflow_x": null,
       "overflow_y": null,
       "padding": null,
       "right": null,
       "top": null,
       "visibility": null,
       "width": null
      }
     },
     "18849786f63a40b1bfa7704f01a915d5": {
      "model_module": "@jupyter-widgets/base",
      "model_module_version": "1.2.0",
      "model_name": "LayoutModel",
      "state": {
       "_model_module": "@jupyter-widgets/base",
       "_model_module_version": "1.2.0",
       "_model_name": "LayoutModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/base",
       "_view_module_version": "1.2.0",
       "_view_name": "LayoutView",
       "align_content": null,
       "align_items": null,
       "align_self": null,
       "border": null,
       "bottom": null,
       "display": null,
       "flex": null,
       "flex_flow": null,
       "grid_area": null,
       "grid_auto_columns": null,
       "grid_auto_flow": null,
       "grid_auto_rows": null,
       "grid_column": null,
       "grid_gap": null,
       "grid_row": null,
       "grid_template_areas": null,
       "grid_template_columns": null,
       "grid_template_rows": null,
       "height": null,
       "justify_content": null,
       "justify_items": null,
       "left": null,
       "margin": null,
       "max_height": null,
       "max_width": null,
       "min_height": null,
       "min_width": null,
       "object_fit": null,
       "object_position": null,
       "order": null,
       "overflow": null,
       "overflow_x": null,
       "overflow_y": null,
       "padding": null,
       "right": null,
       "top": null,
       "visibility": null,
       "width": null
      }
     },
     "342368e071b54e9788b12bd0f5f02226": {
      "model_module": "@jupyter-widgets/controls",
      "model_module_version": "1.5.0",
      "model_name": "ProgressStyleModel",
      "state": {
       "_model_module": "@jupyter-widgets/controls",
       "_model_module_version": "1.5.0",
       "_model_name": "ProgressStyleModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/base",
       "_view_module_version": "1.2.0",
       "_view_name": "StyleView",
       "bar_color": null,
       "description_width": ""
      }
     },
     "4ec719ebf36048138c22ac14b7617eb3": {
      "model_module": "@jupyter-widgets/controls",
      "model_module_version": "1.5.0",
      "model_name": "HBoxModel",
      "state": {
       "_dom_classes": [],
       "_model_module": "@jupyter-widgets/controls",
       "_model_module_version": "1.5.0",
       "_model_name": "HBoxModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/controls",
       "_view_module_version": "1.5.0",
       "_view_name": "HBoxView",
       "box_style": "",
       "children": [
        "IPY_MODEL_7f0109b310a54289980bb2ef392d6cd1",
        "IPY_MODEL_7e5c8cd3912a43b9a52c505f26d05d40",
        "IPY_MODEL_f79f0964735d4b659239f12a0519cdb5"
       ],
       "layout": "IPY_MODEL_4fa4bb11adcf412699d8c6055422271d"
      }
     },
     "4fa4bb11adcf412699d8c6055422271d": {
      "model_module": "@jupyter-widgets/base",
      "model_module_version": "1.2.0",
      "model_name": "LayoutModel",
      "state": {
       "_model_module": "@jupyter-widgets/base",
       "_model_module_version": "1.2.0",
       "_model_name": "LayoutModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/base",
       "_view_module_version": "1.2.0",
       "_view_name": "LayoutView",
       "align_content": null,
       "align_items": null,
       "align_self": null,
       "border": null,
       "bottom": null,
       "display": null,
       "flex": null,
       "flex_flow": null,
       "grid_area": null,
       "grid_auto_columns": null,
       "grid_auto_flow": null,
       "grid_auto_rows": null,
       "grid_column": null,
       "grid_gap": null,
       "grid_row": null,
       "grid_template_areas": null,
       "grid_template_columns": null,
       "grid_template_rows": null,
       "height": null,
       "justify_content": null,
       "justify_items": null,
       "left": null,
       "margin": null,
       "max_height": null,
       "max_width": null,
       "min_height": null,
       "min_width": null,
       "object_fit": null,
       "object_position": null,
       "order": null,
       "overflow": null,
       "overflow_x": null,
       "overflow_y": null,
       "padding": null,
       "right": null,
       "top": null,
       "visibility": null,
       "width": null
      }
     },
     "56721097270040d7a12f9b9e5dc45aa5": {
      "model_module": "@jupyter-widgets/base",
      "model_module_version": "1.2.0",
      "model_name": "LayoutModel",
      "state": {
       "_model_module": "@jupyter-widgets/base",
       "_model_module_version": "1.2.0",
       "_model_name": "LayoutModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/base",
       "_view_module_version": "1.2.0",
       "_view_name": "LayoutView",
       "align_content": null,
       "align_items": null,
       "align_self": null,
       "border": null,
       "bottom": null,
       "display": null,
       "flex": null,
       "flex_flow": null,
       "grid_area": null,
       "grid_auto_columns": null,
       "grid_auto_flow": null,
       "grid_auto_rows": null,
       "grid_column": null,
       "grid_gap": null,
       "grid_row": null,
       "grid_template_areas": null,
       "grid_template_columns": null,
       "grid_template_rows": null,
       "height": null,
       "justify_content": null,
       "justify_items": null,
       "left": null,
       "margin": null,
       "max_height": null,
       "max_width": null,
       "min_height": null,
       "min_width": null,
       "object_fit": null,
       "object_position": null,
       "order": null,
       "overflow": null,
       "overflow_x": null,
       "overflow_y": null,
       "padding": null,
       "right": null,
       "top": null,
       "visibility": null,
       "width": null
      }
     },
     "62516099eb9545a9ab72cb0ca88ebbe4": {
      "model_module": "@jupyter-widgets/controls",
      "model_module_version": "1.5.0",
      "model_name": "DescriptionStyleModel",
      "state": {
       "_model_module": "@jupyter-widgets/controls",
       "_model_module_version": "1.5.0",
       "_model_name": "DescriptionStyleModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/base",
       "_view_module_version": "1.2.0",
       "_view_name": "StyleView",
       "description_width": ""
      }
     },
     "7e5c8cd3912a43b9a52c505f26d05d40": {
      "model_module": "@jupyter-widgets/controls",
      "model_module_version": "1.5.0",
      "model_name": "FloatProgressModel",
      "state": {
       "_dom_classes": [],
       "_model_module": "@jupyter-widgets/controls",
       "_model_module_version": "1.5.0",
       "_model_name": "FloatProgressModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/controls",
       "_view_module_version": "1.5.0",
       "_view_name": "ProgressView",
       "bar_style": "success",
       "description": "",
       "description_tooltip": null,
       "layout": "IPY_MODEL_18849786f63a40b1bfa7704f01a915d5",
       "max": 673.0,
       "min": 0.0,
       "orientation": "horizontal",
       "style": "IPY_MODEL_342368e071b54e9788b12bd0f5f02226",
       "value": 673.0
      }
     },
     "7f0109b310a54289980bb2ef392d6cd1": {
      "model_module": "@jupyter-widgets/controls",
      "model_module_version": "1.5.0",
      "model_name": "HTMLModel",
      "state": {
       "_dom_classes": [],
       "_model_module": "@jupyter-widgets/controls",
       "_model_module_version": "1.5.0",
       "_model_name": "HTMLModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/controls",
       "_view_module_version": "1.5.0",
       "_view_name": "HTMLView",
       "description": "",
       "description_tooltip": null,
       "layout": "IPY_MODEL_56721097270040d7a12f9b9e5dc45aa5",
       "placeholder": "​",
       "style": "IPY_MODEL_62516099eb9545a9ab72cb0ca88ebbe4",
       "value": "Processing planets: 100%"
      }
     },
     "bc60517c21044fa7b78d80a120f87962": {
      "model_module": "@jupyter-widgets/controls",
      "model_module_version": "1.5.0",
      "model_name": "DescriptionStyleModel",
      "state": {
       "_model_module": "@jupyter-widgets/controls",
       "_model_module_version": "1.5.0",
       "_model_name": "DescriptionStyleModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/base",
       "_view_module_version": "1.2.0",
       "_view_name": "StyleView",
       "description_width": ""
      }
     },
     "f79f0964735d4b659239f12a0519cdb5": {
      "model_module": "@jupyter-widgets/controls",
      "model_module_version": "1.5.0",
      "model_name": "HTMLModel",
      "state": {
       "_dom_classes": [],
       "_model_module": "@jupyter-widgets/controls",
       "_model_module_version": "1.5.0",
       "_model_name": "HTMLModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/controls",
       "_view_module_version": "1.5.0",
       "_view_name": "HTMLView",
       "description": "",
       "description_tooltip": null,
       "layout": "IPY_MODEL_0cc41ee128114e4ca3abbece6f58dc1a",
       "placeholder": "​",
       "style": "IPY_MODEL_bc60517c21044fa7b78d80a120f87962",
       "value": " 673/673 [2:29:33&lt;00:00, 13.91s/it]"
      }
     }
    },
    "version_major": 2,
    "version_minor": 0
   }
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
